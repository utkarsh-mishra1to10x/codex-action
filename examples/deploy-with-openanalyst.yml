name: Smart Deploy to Render with OpenAnalyst

run-name: ${{ github.actor }} is deploying to Render with AI assistance ðŸš€ðŸ¤–

on:
  push:
    branches: [ "main", "feature-integration" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_ai_review:
        description: 'Run AI code review before deploy?'
        required: false
        default: 'true'
        type: boolean
      fix_issues:
        description: 'Let AI fix issues automatically?'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================================================
  # JOB 1: AI Code Review (Optional but Recommended)
  # ============================================================================
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.run_ai_review == 'true')
    outputs:
      review_result: ${{ steps.review.outputs.final-message }}
      has_issues: ${{ steps.check.outputs.has_issues }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build OpenAnalyst Proxy
        working-directory: ${{ github.workspace }}
        run: |
          # If using from same repo, build the proxy
          if [ -d "openanalyst-proxy" ]; then
            cd openanalyst-proxy
            npm install
            npm run build
          fi

      - name: AI Code Review
        id: review
        uses: utkarsh-mishra1to10x/codex-action@main  # Your forked repo
        with:
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: "anthropic/claude-3.5-sonnet"
          prompt: |
            You are a senior code reviewer. Review the recent changes in this repository.

            First, run these commands to understand the changes:
            ```
            git log --oneline -10
            git diff HEAD~1
            ```

            Review for:
            1. **Security Issues**: API keys exposed, SQL injection, XSS vulnerabilities
            2. **Bug Potential**: Null checks, error handling, edge cases
            3. **Performance**: N+1 queries, memory leaks, inefficient loops
            4. **Best Practices**: Code style, naming conventions, documentation

            Format your response as:
            ## Review Summary
            - Overall assessment (PASS/NEEDS_ATTENTION/CRITICAL)

            ## Issues Found
            - List each issue with severity (HIGH/MEDIUM/LOW)

            ## Recommendations
            - Specific suggestions for improvement

      - name: Check for critical issues
        id: check
        run: |
          REVIEW="${{ steps.review.outputs.final-message }}"
          if echo "$REVIEW" | grep -qi "CRITICAL\|HIGH"; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Critical or high severity issues found!"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "âœ… No critical issues found"
          fi

      - name: Post Review Comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `##  OpenAnalyst Code Review

            ${{ steps.review.outputs.final-message }}

            ---
            *Powered by OpenAnalyst with Claude 3.5 Sonnet*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: review
            });

  # ============================================================================
  # JOB 2: AI Fix Issues (Optional)
  # ============================================================================
  ai-fix:
    name: AI Auto-Fix
    runs-on: ubuntu-latest
    needs: ai-review
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.fix_issues == 'true' &&
      needs.ai-review.outputs.has_issues == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Fix Issues
        id: fix
        uses: utkarsh-mishra1to10x/codex-action@main
        with:
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: "anthropic/claude-3.5-sonnet"
          prompt: |
            Previous review found these issues:
            ${{ needs.ai-review.outputs.review_result }}

            Please fix the issues:
            1. Read the files mentioned in the review
            2. Apply the necessary fixes
            3. Run any available tests to verify

            After fixing, summarize what was changed.

      - name: Commit fixes
        run: |
          git config user.name "OpenAnalyst Bot"
          git config user.email "bot@openanalyst.ai"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "fix: AI auto-fix for review issues"
            git push
          fi

  # ============================================================================
  # JOB 3: Deploy to Render
  # ============================================================================
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [ai-review]
    # Deploy if: push to main, or manual trigger, or PR review passed
    if: |
      always() &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (needs.ai-review.result == 'skipped' || needs.ai-review.outputs.has_issues != 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Triggering deployment to Render..."

          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "âŒ ERROR: Missing required secrets!"
            exit 1
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Deployment triggered successfully!"
            DEPLOY_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
            echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Deployment failed with status $HTTP_CODE"
            exit 1
          fi

      - name: Wait and Check Status
        run: |
          echo "â³ Waiting for deployment to start..."
          sleep 30
          echo "âœ… Deployment is in progress!"

  # ============================================================================
  # JOB 4: AI Post-Deploy Verification (Optional)
  # ============================================================================
  verify-deployment:
    name: AI Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Verify Deployment
        uses: utkarsh-mishra1to10x/codex-action@main
        with:
          api-key: ${{ secrets.OPENROUTER_API_KEY }}
          model: "openai/gpt-4o-mini"  # Cheaper model for simple task
          prompt: |
            Deployment to Render has been triggered.

            Please verify:
            1. Check if there are any obvious configuration issues in the codebase
            2. List the environment variables that should be set (from docker-compose or Dockerfile)
            3. Suggest any post-deployment verification steps

            Read these files if they exist:
            - Dockerfile
            - docker-compose.yml
            - render.yaml
            - .env.example

      - name: Deployment Summary
        run: |
          echo "### ðŸŽ‰ Deployment Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AI Review:** ${{ needs.ai-review.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Status:** Success" >> $GITHUB_STEP_SUMMARY
